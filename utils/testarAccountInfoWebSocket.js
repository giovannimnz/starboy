const path = require('path');
require('dotenv').config({ path: path.join(__dirname, '..', '.env') });

const { getDatabaseInstance } = require('../db/conexao');
const websockets = require('../websockets');
const websocketApi = require('../websocketApi');

/**
 * Teste espec√≠fico para getAccountInformationV2 via WebSocket API
 */
async function testarAccountInformationV2() {
  console.log('üöÄ Iniciando teste detalhado de informa√ß√µes da conta via WebSocket API...\n');
  
  try {
    // === ETAPA 1: Verificar conex√£o com banco ===
    console.log('üìä ETAPA 1: Verificando conex√£o com banco de dados...');
    const db = await getDatabaseInstance();
    if (!db) {
      throw new Error('N√£o foi poss√≠vel conectar ao banco de dados');
    }
    console.log('‚úÖ Banco de dados conectado com sucesso\n');

    // === ETAPA 2: Carregar credenciais ===
    console.log('üîë ETAPA 2: Carregando credenciais da conta 1...');
    try {
      const credentials = await websockets.loadCredentialsFromDatabase(1);
      console.log('‚úÖ Credenciais carregadas com sucesso');
      console.log(`üìã Detalhes das credenciais:`);
      console.log(`- API Key: ${credentials.apiKey ? credentials.apiKey.substring(0, 8) + '...' : 'N√ÉO ENCONTRADA'}`);
      console.log(`- Secret Key: ${credentials.secretKey ? 'ENCONTRADA' : 'N√ÉO ENCONTRADA'}`);
      console.log(`- WS API Key: ${credentials.wsApiKey ? credentials.wsApiKey.substring(0, 8) + '...' : 'N√ÉO ENCONTRADA'}`);
      console.log(`- Private Key: ${credentials.privateKey ? 'ENCONTRADA' : 'N√ÉO ENCONTRADA'}`);
      console.log();
    } catch (credError) {
      console.error('‚ùå Erro ao carregar credenciais:', credError.message);
      throw credError;
    }

    // === ETAPA 3: Verificar estado da conta ===
    console.log('üîó ETAPA 3: Verificando estado da conex√£o da conta...');
    
    // CORRE√á√ÉO: Usar fun√ß√£o que existe e debug detalhado
    let accountState = websockets.getAccountConnectionState(1);
    
    if (!accountState) {
      console.log('‚ö†Ô∏è Estado da conta n√£o existe ainda, tentando inicializar...');
      
      // Tentar obter todas as conex√µes para debug
      const allConnections = websockets.getAllAccountConnections();
      console.log(`üìä Total de conex√µes no mapa: ${allConnections.size}`);
      
      // Verificar se existe no accountConnections
      if (allConnections.has(1)) {
        console.log('‚úÖ Conta 1 existe no mapa de conex√µes');
        accountState = allConnections.get(1);
      } else {
        console.log('‚ùå Conta 1 n√£o existe no mapa de conex√µes');
        
        // Tentar for√ßar inicializa√ß√£o
        console.log('üîÑ Tentando for√ßar inicializa√ß√£o do estado...');
        accountState = websockets.getAccountConnectionState(1, true); // For√ßar cria√ß√£o
        
        if (!accountState) {
          throw new Error('Imposs√≠vel inicializar estado da conta mesmo for√ßando');
        }
      }
    }
    
    console.log('üìã Informa√ß√µes do estado da conta:');
    console.log(`- API Key: ${accountState.apiKey ? accountState.apiKey.substring(0, 8) + '...' : 'N√ÉO ENCONTRADA'}`);
    console.log(`- WS API Key: ${accountState.wsApiKey ? accountState.wsApiKey.substring(0, 8) + '...' : 'N√ÉO ENCONTRADA'}`);
    console.log(`- Private Key: ${accountState.privateKey ? 'CONFIGURADA' : 'N√ÉO ENCONTRADA'}`);
    console.log(`- WS API URL: ${accountState.wsApiUrl || 'PADR√ÉO'}`);
    console.log(`- Authenticated: ${accountState.isAuthenticated || accountState.wsApiAuthenticated || false}`);
    console.log();

    // === ETAPA 4: Testar conex√£o WebSocket b√°sica ===
    console.log('üåê ETAPA 4: Testando conex√£o WebSocket API b√°sica...');
    
    try {
      // Teste direto de conex√£o
      const wsApiUrl = accountState.wsApiUrl || 'wss://ws-fapi.binance.com/ws-fapi/v1';
      console.log(`üîÑ Testando conex√£o direta em: ${wsApiUrl}`);
      
      const WebSocket = require('ws');
      const testWs = new WebSocket(wsApiUrl);
      
      const connectionTest = await new Promise((resolve, reject) => {
        const timeout = setTimeout(() => {
          testWs.close();
          reject(new Error('Timeout na conex√£o b√°sica'));
        }, 10000);
        
        testWs.on('open', () => {
          clearTimeout(timeout);
          console.log('‚úÖ Conex√£o b√°sica WebSocket API estabelecida!');
          
          // Testar comando b√°sico
          testWs.send(JSON.stringify({
            id: 'test-connection',
            method: 'time',
            params: {}
          }));
        });
        
        testWs.on('message', (data) => {
          try {
            const response = JSON.parse(data);
            console.log('üì® Resposta do teste b√°sico:', response);
            testWs.close();
            resolve(true);
          } catch (e) {
            console.log('üì® Resposta n√£o-JSON:', data.toString());
            testWs.close();
            resolve(true);
          }
        });
        
        testWs.on('error', (error) => {
          clearTimeout(timeout);
          reject(error);
        });
      });
      
      console.log('‚úÖ Teste de conex√£o b√°sica foi bem-sucedido\n');
      
    } catch (wsError) {
      console.error('‚ùå Erro na conex√£o WebSocket b√°sica:', wsError.message);
      console.log('‚ö†Ô∏è Continuando com teste usando sistema interno...\n');
    }

    // === ETAPA 5: Tentar inicializar WebSocket API via sistema ===
    console.log('üîß ETAPA 5: Inicializando WebSocket API via sistema...');
    
    try {
      console.log('üìû Chamando websockets.startWebSocketApi(1)...');
      const wsConnected = await websockets.startWebSocketApi(1);
      
      if (wsConnected) {
        console.log('‚úÖ WebSocket API inicializado com sucesso!');
      } else {
        console.log('‚ö†Ô∏è WebSocket API n√£o foi inicializado, mas continuando...');
      }
    } catch (wsInitError) {
      console.warn('‚ö†Ô∏è Erro ao inicializar WebSocket API:', wsInitError.message);
    }
    console.log();

    // === ETAPA 6: Verificar status da sess√£o ===
    console.log('üîç ETAPA 6: Verificando status da sess√£o WebSocket...');
    try {
      const sessionStatus = await websockets.checkSessionStatus(1);
      console.log('üìä Status da sess√£o:', JSON.stringify(sessionStatus, null, 2));
    } catch (sessionError) {
      console.warn('‚ö†Ô∏è Erro ao verificar status da sess√£o:', sessionError.message);
    }
    console.log();

    // === ETAPA 7: Testar getAccountInformationV2 ===
    console.log('üéØ ETAPA 7: Testando getAccountInformationV2...');
    
    try {
      console.log('üìû Chamando websocketApi.getAccountInformationV2(1)...');
      const accountInfo = await websocketApi.getAccountInformationV2({}, 1); // CORRE√á√ÉO: Passar accountId explicitamente
      
      console.log('üéâ SUCESSO! Informa√ß√µes da conta obtidas via WebSocket API:');
      console.log('üìä Resposta completa:', JSON.stringify(accountInfo, null, 2));
      
      // Extrair informa√ß√µes importantes
      if (accountInfo && accountInfo.result) {
        const { totalWalletBalance, availableBalance, maxWithdrawAmount } = accountInfo.result;
        console.log('\nüí∞ Resumo Financeiro via WebSocket API:');
        console.log(`- Saldo Total: ${totalWalletBalance || 'N/A'} USDT`);
        console.log(`- Saldo Dispon√≠vel: ${availableBalance || 'N/A'} USDT`);
        console.log(`- M√°ximo para Saque: ${maxWithdrawAmount || 'N/A'} USDT`);
      }
      
    } catch (apiError) {
      console.error('‚ùå Erro ao chamar getAccountInformationV2:', apiError.message);
      console.error('üìã Stack trace:', apiError.stack);
      
      // === ETAPA 7B: Teste alternativo via REST API ===
      console.log('\nüîÑ ETAPA 7B: Tentando via REST API como fallback...');
      try {
        const api = require('../api');
        const restAccountInfo = await api.getAccountInfo(1);
        console.log('‚úÖ REST API funcionou! Informa√ß√µes via REST:');
        console.log('üìä Saldo Total via REST:', restAccountInfo.totalWalletBalance || 'N/A');
      } catch (restError) {
        console.error('‚ùå REST API tamb√©m falhou:', restError.message);
      }
    }

    // === ETAPA 8: Diagn√≥stico detalhado ===
    console.log('\nüîß ETAPA 8: Diagn√≥stico detalhado do WebSocket...');
    
    console.log('üîç Estado atual das conex√µes:');
    console.log(`- WebSocket API conectado: ${websockets.isWebSocketApiConnected(1)}`);
    console.log(`- WebSocket API autenticado: ${websockets.isWebSocketApiAuthenticated(1)}`);
    
    const allConnections = websockets.getAllAccountConnections();
    console.log(`- Total de conex√µes ativas: ${allConnections.size}`);
    
    if (allConnections.has(1)) {
      const conn = allConnections.get(1);
      console.log('üìã Detalhes da conex√£o da conta 1:');
      console.log(`  - wsApi existe: ${conn.wsApi ? 'SIM' : 'N√ÉO'}`);
      console.log(`  - wsApi estado: ${conn.wsApi ? conn.wsApi.readyState : 'N/A'}`);
      console.log(`  - isAuthenticated: ${conn.isAuthenticated}`);
      console.log(`  - wsApiAuthenticated: ${conn.wsApiAuthenticated}`);
      console.log(`  - requestCallbacks: ${conn.requestCallbacks ? conn.requestCallbacks.size : 'N/A'}`);
    }

    console.log('\nüéâ Teste conclu√≠do com diagn√≥stico completo!');

  } catch (error) {
    console.error('\n‚ùå ERRO GERAL NO TESTE:', error.message);
    console.error('üìã Stack trace completo:', error.stack);
  } finally {
    // === LIMPEZA ===
    console.log('\nüßπ Limpando conex√µes...');
    try {
      websockets.reset(1);
      console.log('‚úÖ Conex√µes limpas com sucesso');
    } catch (cleanupError) {
      console.error('‚ö†Ô∏è Erro na limpeza:', cleanupError.message);
    }
    
    console.log('\nüèÅ Teste finalizado');
    process.exit(0);
  }
}

// === FUN√á√ÉO AUXILIAR: Teste de conex√£o b√°sica ===
async function testarConexaoBasica() {
  console.log('üîß Testando conex√£o WebSocket b√°sica...');
  
  const WebSocket = require('ws');
  const wsUrl = 'wss://ws-fapi.binance.com/ws-fapi/v1';
  
  return new Promise((resolve) => {
    const ws = new WebSocket(wsUrl);
    const timeout = setTimeout(() => {
      ws.close();
      console.log('‚ùå Timeout na conex√£o b√°sica');
      resolve(false);
    }, 5000);
    
    ws.on('open', () => {
      clearTimeout(timeout);
      console.log('‚úÖ Conex√£o b√°sica funcionou!');
      
      // Testar comando b√°sico
      ws.send(JSON.stringify({
        id: 'test-basic',
        method: 'time',
        params: {}
      }));
    });
    
    ws.on('message', (data) => {
      try {
        const response = JSON.parse(data);
        console.log('üì® Resposta b√°sica:', response);
        ws.close();
        resolve(true);
      } catch (e) {
        console.log('üì® Resposta n√£o-JSON:', data.toString());
        ws.close();
        resolve(true);
      }
    });
    
    ws.on('error', (error) => {
      clearTimeout(timeout);
      console.error('‚ùå Erro na conex√£o b√°sica:', error.message);
      resolve(false);
    });
  });
}

// === EXECU√á√ÉO PRINCIPAL ===
console.log('='.repeat(60));
console.log('üß™ TESTE ESPEC√çFICO: WebSocket API - Account Information V2');
console.log('='.repeat(60));
console.log();

// Executar teste b√°sico primeiro
testarConexaoBasica().then(() => {
  console.log();
  // Depois executar teste completo
  testarAccountInformationV2();
});