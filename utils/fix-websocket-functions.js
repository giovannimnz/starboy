const fs = require('fs');
const path = require('path');

console.log('üîß Verificando e corrigindo fun√ß√µes WebSocket...\n');

// Fun√ß√£o para fazer backup
function createBackup(filePath) {
  const backupPath = `${filePath}.backup.ws-functions.${Date.now()}`;
  if (fs.existsSync(filePath)) {
    fs.copyFileSync(filePath, backupPath);
    console.log(`üìÅ Backup criado: ${backupPath}`);
    return true;
  }
  return false;
}

// Verificar websockets.js
console.log('1Ô∏è‚É£ Verificando websockets.js...');
const websocketsPath = path.join(__dirname, 'websockets.js');

if (fs.existsSync(websocketsPath)) {
  let websocketsContent = fs.readFileSync(websocketsPath, 'utf8');
  
  // Verificar se sendWebSocketApiRequest existe e est√° sendo exportada
  const hasSendFunction = websocketsContent.includes('sendWebSocketApiRequest');
  const hasExport = websocketsContent.includes('sendWebSocketApiRequest') && 
                   websocketsContent.includes('module.exports') && 
                   websocketsContent.match(/module\.exports\s*=\s*\{[^}]*sendWebSocketApiRequest/s);
  
  console.log(`- sendWebSocketApiRequest existe: ${hasSendFunction}`);
  console.log(`- sendWebSocketApiRequest exportada: ${hasExport}`);
  
  if (!hasSendFunction) {
    console.log('‚ûï Adicionando fun√ß√£o sendWebSocketApiRequest...');
    
    createBackup(websocketsPath);
    
    const sendWebSocketApiRequestFunction = `
/**
 * Envia requisi√ß√£o via WebSocket API
 * @param {Object} request - Dados da requisi√ß√£o
 * @param {number} timeout - Timeout em ms (padr√£o: 30000)
 * @param {number} accountId - ID da conta
 * @returns {Promise<Object>} - Resposta da API
 */
async function sendWebSocketApiRequest(request, timeout = 30000, accountId) {
  return new Promise((resolve, reject) => {
    console.log(\`[WS-API] Enviando requisi√ß√£o WebSocket para conta \${accountId}:\`, request);
    
    if (!accountId || typeof accountId !== 'number') {
      console.error(\`[WS-API] AccountId inv√°lido: \${accountId}\`);
      return reject(new Error('AccountId √© obrigat√≥rio e deve ser um n√∫mero'));
    }

    const accountState = getAccountConnectionState(accountId);
    if (!accountState || !accountState.wsApiConnection) {
      console.error(\`[WS-API] WebSocket n√£o conectado para conta \${accountId}\`);
      return reject(new Error('WebSocket n√£o conectado'));
    }

    const connection = accountState.wsApiConnection;
    if (connection.readyState !== 1) {
      console.error(\`[WS-API] WebSocket n√£o est√° no estado OPEN para conta \${accountId}, estado atual: \${connection.readyState}\`);
      return reject(new Error('WebSocket n√£o est√° conectado'));
    }

    // Gerar ID √∫nico para a requisi√ß√£o
    const requestId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    const message = {
      id: requestId,
      method: request.method,
      params: request.params || {}
    };

    // Configurar timeout
    const timeoutId = setTimeout(() => {
      if (accountState.wsApiRequestCallbacks.has(requestId)) {
        accountState.wsApiRequestCallbacks.delete(requestId);
        console.error(\`[WS-API] Timeout na requisi√ß√£o \${request.method} para conta \${accountId}\`);
        reject(new Error(\`Timeout na requisi√ß√£o \${request.method}\`));
      }
    }, timeout);

    // Registrar callback
    accountState.wsApiRequestCallbacks.set(requestId, (response) => {
      clearTimeout(timeoutId);
      
      if (response.error) {
        console.error(\`[WS-API] Erro na resposta \${request.method} para conta \${accountId}:\`, response.error);
        reject(new Error(\`API Error: \${response.error.code} - \${response.error.msg}\`));
      } else {
        console.log(\`[WS-API] ‚úÖ Resposta recebida para \${request.method} (conta \${accountId})\`);
        resolve(response);
      }
    });

    try {
      connection.send(JSON.stringify(message));
      console.log(\`[WS-API] Mensagem enviada para conta \${accountId}: \${request.method}\`);
    } catch (error) {
      clearTimeout(timeoutId);
      accountState.wsApiRequestCallbacks.delete(requestId);
      console.error(\`[WS-API] Erro ao enviar mensagem para conta \${accountId}:\`, error.message);
      reject(error);
    }
  });
}`;

    // Adicionar a fun√ß√£o antes do module.exports
    websocketsContent = websocketsContent.replace(
      /module\.exports\s*=/,
      `${sendWebSocketApiRequestFunction}\n\nmodule.exports =`
    );
    
    // Adicionar ao exports se n√£o estiver
    if (!websocketsContent.includes('sendWebSocketApiRequest')) {
      websocketsContent = websocketsContent.replace(
        /module\.exports = \{([^}]+)\}/s,
        (match, exports) => {
          return `module.exports = {${exports},
  sendWebSocketApiRequest
}`;
        }
      );
    }
    
    fs.writeFileSync(websocketsPath, websocketsContent, 'utf8');
    console.log('‚úÖ sendWebSocketApiRequest adicionada ao websockets.js');
  }
  
  if (!hasExport && hasSendFunction) {
    console.log('‚ûï Adicionando sendWebSocketApiRequest ao exports...');
    
    websocketsContent = websocketsContent.replace(
      /module\.exports = \{([^}]+)\}/s,
      (match, exports) => {
        if (!exports.includes('sendWebSocketApiRequest')) {
          return `module.exports = {${exports},
  sendWebSocketApiRequest
}`;
        }
        return match;
      }
    );
    
    fs.writeFileSync(websocketsPath, websocketsContent, 'utf8');
    console.log('‚úÖ sendWebSocketApiRequest adicionada ao exports');
  }
} else {
  console.error('‚ùå websockets.js n√£o encontrado');
}

// Verificar e corrigir websocketApi.js
console.log('\n2Ô∏è‚É£ Corrigindo websocketApi.js...');
const websocketApiPath = path.join(__dirname, 'websocketApi.js');

if (fs.existsSync(websocketApiPath)) {
  createBackup(websocketApiPath);
  
  let content = fs.readFileSync(websocketApiPath, 'utf8');
  
  // Garantir que os imports est√£o corretos
  const correctImports = `const api = require('./api');
const { getDatabaseInstance } = require('./db/conexao');
const websockets = require('./websockets');
const { sendWebSocketApiRequest } = require('./websockets');`;

  // Substituir imports existentes
  content = content.replace(
    /^(const.*require.*\n)+/m,
    correctImports + '\n\n'
  );
  
  // Verificar se getAccountConnectionState est√° sendo importado
  if (!content.includes('getAccountConnectionState')) {
    content = content.replace(
      correctImports,
      correctImports + '\nconst { getAccountConnectionState } = require(\'./api\');'
    );
  }
  
  fs.writeFileSync(websocketApiPath, content, 'utf8');
  console.log('‚úÖ websocketApi.js corrigido com imports corretos');
} else {
  console.error('‚ùå websocketApi.js n√£o encontrado');
}

// Criar um teste mais espec√≠fico
console.log('\n3Ô∏è‚É£ Criando teste mais espec√≠fico...');

const advancedTestScript = `// Teste avan√ßado do WebSocket API
const websockets = require('./websockets');
const websocketApi = require('./websocketApi');

async function testAdvanced() {
  console.log('üß™ Teste avan√ßado do WebSocket API...');
  
  try {
    console.log('\\n=== TESTE 1: Verificar imports ===');
    console.log('- websockets.sendWebSocketApiRequest:', typeof websockets.sendWebSocketApiRequest);
    console.log('- websockets.startWebSocketApi:', typeof websockets.startWebSocketApi);
    console.log('- websockets.isWebSocketApiConnected:', typeof websockets.isWebSocketApiConnected);
    
    console.log('\\n=== TESTE 2: Verificar websocketApi ===');
    console.log('- websocketApi.getAccountInformationV2:', typeof websocketApi.getAccountInformationV2);
    console.log('- websocketApi.getAccountBalance:', typeof websocketApi.getAccountBalance);
    
    if (typeof websockets.sendWebSocketApiRequest !== 'function') {
      console.error('‚ùå sendWebSocketApiRequest n√£o est√° dispon√≠vel em websockets');
      return false;
    }
    
    console.log('\\n=== TESTE 3: Inicializar WebSocket API ===');
    const isConnected = websockets.isWebSocketApiConnected(1);
    console.log('WebSocket conectado:', isConnected);
    
    if (!isConnected) {
      console.log('Conectando WebSocket...');
      await websockets.startWebSocketApi(1);
      await new Promise(resolve => setTimeout(resolve, 2000));
    }
    
    console.log('\\n=== TESTE 4: Testar getAccountInformationV2 ===');
    const result = await websocketApi.getAccountInformationV2({}, 1);
    console.log('Resultado completo:', {
      status: result?.status,
      hasResult: !!result?.result,
      hasError: !!result?.error,
      errorMessage: result?.error?.message
    });
    
    if (result && result.status === 200) {
      console.log('‚úÖ WebSocket API funcionando!');
      
      console.log('\\n=== TESTE 5: Testar getAccountBalance ===');
      const balance = await websocketApi.getAccountBalance({}, 1);
      console.log('Saldo resultado:', {
        success: balance?.success,
        totalWalletBalance: balance?.totalWalletBalance,
        availableBalance: balance?.availableBalance
      });
      
      return true;
    } else {
      console.log('‚ö†Ô∏è WebSocket API com problemas, mas fun√ß√£o existe');
      return true;
    }
    
  } catch (error) {
    console.error('‚ùå Erro no teste avan√ßado:', error.message);
    console.error('Stack:', error.stack);
    return false;
  }
}

if (require.main === module) {
  testAdvanced().then(success => {
    if (success) {
      console.log('\\nüéâ Teste conclu√≠do com sucesso!');
      console.log('\\nüöÄ Execute o monitoramento:');
      console.log('   node posicoes/monitoramento.js --account 1');
    } else {
      console.log('\\n‚ùå Teste falhou');
      process.exit(1);
    }
  });
}

module.exports = { testAdvanced };`;

fs.writeFileSync(path.join(__dirname, 'test-websocket-advanced.js'), advancedTestScript);
console.log('‚úÖ Arquivo de teste avan√ßado criado: test-websocket-advanced.js');

console.log('\nüéâ Corre√ß√£o de fun√ß√µes WebSocket conclu√≠da!');
console.log('\nüìã Principais corre√ß√µes:');
console.log('1. ‚úÖ Verifica√ß√£o e adi√ß√£o de sendWebSocketApiRequest');
console.log('2. ‚úÖ Imports corrigidos em websocketApi.js');
console.log('3. ‚úÖ Exports corrigidos em websockets.js');
console.log('4. ‚úÖ Teste avan√ßado criado');

console.log('\nüß™ Execute o teste avan√ßado:');
console.log('   node test-websocket-advanced.js');

console.log('\nüíæ Backups criados para seguran√ßa.');